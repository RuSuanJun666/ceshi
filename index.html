<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½æ¯›çƒæ™ºèƒ½ç¼–æ’ç³»ç»Ÿ</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¸ ç¾½æ¯›çƒæ™ºèƒ½ç¼–æ’ç³»ç»Ÿ</h1>
            <div class="mode-toggle">
                <button id="singlesMode" class="active">å•æ‰“æ¨¡å¼</button>
                <button id="doublesMode">åŒæ‰“æ¨¡å¼</button>
            </div>
        </header>

        <main>
            <!-- é€‰æ‰‹ç®¡ç†åŒºåŸŸ -->
            <section class="player-management">
                <h2>é€‰æ‰‹ç®¡ç†</h2>
                <div class="input-group">
                    <textarea id="batchPlayers" placeholder="æ‰¹é‡æ·»åŠ é€‰æ‰‹ï¼ˆæ¯è¡Œä¸€ä¸ªåå­—ï¼Œæˆ–ç”¨é€—å·/åˆ†å·åˆ†éš”ï¼‰"></textarea>
                    <button id="batchAdd">æ‰¹é‡å¯¼å…¥</button>
                </div>
                <div class="input-group">
                    <input type="text" id="singlePlayer" placeholder="è¾“å…¥å•ä¸ªé€‰æ‰‹å§“å">
                    <button id="addPlayer">æ·»åŠ é€‰æ‰‹</button>
                    <button id="clearPlayers">æ¸…ç©ºåˆ—è¡¨</button>
                </div>
                
                <div class="player-list-container">
                    <h3>å½“å‰é€‰æ‰‹åˆ—è¡¨ <span id="playerCount">0</span>äºº</h3>
                    <div id="playerList" class="player-list"></div>
                </div>
            </section>

            <!-- æ¯”èµ›è®¾ç½®åŒºåŸŸ -->
            <section class="tournament-settings">
                <h2>æ¯”èµ›è®¾ç½®</h2>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="roundOptions">æ¯”èµ›è½®æ¬¡ï¼š</label>
                        <select id="roundOptions" disabled>
                            <option value="">è¯·å…ˆæ·»åŠ é€‰æ‰‹</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="totalMatches">æ€»æ¯”èµ›åœºæ•°ï¼š</label>
                        <span id="totalMatches">0</span>åœº
                    </div>
                </div>
                <button id="generateMatches" disabled>ç”Ÿæˆå¯¹é˜µè¡¨</button>
            </section>

            <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
            <section class="results">
                <div class="results-header">
                    <h2>æ¯”èµ›ç»“æœ</h2>
                    <div class="result-actions">
                        <button id="exportData">å¯¼å‡ºæ•°æ®</button>
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab-btn active" data-tab="matches">å¯¹é˜µè¡¨</button>
                    <button class="tab-btn" data-tab="standings">ç§¯åˆ†æ¦œ</button>
                    <button class="tab-btn" data-tab="schedule">èµ›ç¨‹å®‰æ’</button>
                </div>
                
                <div id="matchesTab" class="tab-content active">
                    <div id="matchesContainer"></div>
                </div>
                
                <div id="standingsTab" class="tab-content">
                    <table id="standingsTable">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>é€‰æ‰‹</th>
                                <th>èƒœåœº</th>
                                <th>æ€»å¾—åˆ†</th>
                                <th>å‚èµ›åœºæ¬¡</th>
                                <th>èƒœç‡</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="scheduleTab" class="tab-content">
                    <div id="scheduleContainer"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // é€‰æ‰‹ç®¡ç†é€»è¾‘
        document.addEventListener('DOMContentLoaded', function() {
            const players = [];
            let currentMode = 'singles';
            let hasMatchesGenerated = false; // æ·»åŠ æ ‡è®°ï¼Œè¡¨ç¤ºæ˜¯å¦å·²ç”Ÿæˆå¯¹é˜µè¡¨
            let selectedPlayers = []; // ç”¨äºå­˜å‚¨å½“å‰é€‰ä¸­çš„é€‰æ‰‹ï¼ˆæœ€å¤š2ä¸ªï¼‰
            let saveAttempts = new Map(); // ç”¨äºè®°å½•æ¯åœºæ¯”èµ›çš„ä¿å­˜å°è¯•æ¬¡æ•°
            
            // DOMå…ƒç´ 
            const elements = {
                batchPlayers: document.getElementById('batchPlayers'),
                singlePlayer: document.getElementById('singlePlayer'),
                playerList: document.getElementById('playerList'),
                playerCount: document.getElementById('playerCount'),
                roundOptions: document.getElementById('roundOptions'),
				generateMatches: document.getElementById('generateMatches'),
                totalMatches: document.getElementById('totalMatches'),
                matchesContainer: document.getElementById('matchesContainer'),
                standingsTable: document.querySelector('#standingsTable tbody')
            };
            
            // æŒ‰é’®äº‹ä»¶
            document.getElementById('batchAdd').addEventListener('click', batchAddPlayers);
            document.getElementById('addPlayer').addEventListener('click', addSinglePlayer);
            document.getElementById('clearPlayers').addEventListener('click', clearPlayers);
            document.getElementById('generateMatches').addEventListener('click', generateMatches);
            document.getElementById('singlesMode').addEventListener('click', () => switchMode('singles'));
            document.getElementById('doublesMode').addEventListener('click', () => switchMode('doubles'));
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // æ‰¹é‡æ·»åŠ é€‰æ‰‹
            function batchAddPlayers() {
                if (hasMatchesGenerated) {
                    if (!confirm('å·²å­˜åœ¨å¯¹é˜µè¡¨ï¼Œæ·»åŠ æ–°é€‰æ‰‹å°†æ¸…ç©ºå½“å‰å¯¹é˜µè¡¨å’Œæ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                    resetTournament();
                }
                
                const input = elements.batchPlayers.value.trim();
                if (!input) return;
                
                // æ”¯æŒå¤šç§åˆ†éš”ç¬¦
                const newPlayers = input.split(/[\n,;]+/).map(p => p.trim()).filter(p => p);
                
                newPlayers.forEach(player => {
                    if (!players.some(p => p.name === player)) {
                        players.push({
                            id: generateId(),
                            name: player
                        });
                    }
                });
                
                updatePlayerList();
                elements.batchPlayers.value = '';
            }
            
            // æ·»åŠ å•ä¸ªé€‰æ‰‹
            function addSinglePlayer() {
                if (hasMatchesGenerated) {
                    if (!confirm('å·²å­˜åœ¨å¯¹é˜µè¡¨ï¼Œæ·»åŠ æ–°é€‰æ‰‹å°†æ¸…ç©ºå½“å‰å¯¹é˜µè¡¨å’Œæ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                    resetTournament();
                }
                
                const name = elements.singlePlayer.value.trim();
                if (!name || players.some(p => p.name === name)) return;
                
                players.push({
                    id: generateId(),
                    name: name
                });
                
                updatePlayerList();
                elements.singlePlayer.value = '';
            }
            
            // æ¸…ç©ºé€‰æ‰‹åˆ—è¡¨
            function clearPlayers() {
                let message = 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é€‰æ‰‹å—ï¼Ÿ';
                if (hasMatchesGenerated) {
                    message = 'æ¸…ç©ºé€‰æ‰‹åˆ—è¡¨å°†åŒæ—¶æ¸…ç©ºå½“å‰å¯¹é˜µè¡¨å’Œæ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ';
                }
                
                if (confirm(message)) {
                    resetTournament();
                    players.length = 0;
                    updatePlayerList();
                }
            }
            
            // æ›´æ–°é€‰æ‰‹åˆ—è¡¨æ˜¾ç¤º
            function updatePlayerList() {
                elements.playerList.innerHTML = '';
                elements.playerCount.textContent = players.length;
                
                players.forEach(player => {
                    const playerTag = document.createElement('div');
                    playerTag.className = 'player-tag';
                    playerTag.innerHTML = `
                        ${player.name}
                        <button data-id="${player.id}">Ã—</button>
                    `;
                    elements.playerList.appendChild(playerTag);
                });
                
                // æ·»åŠ åˆ é™¤äº‹ä»¶
                document.querySelectorAll('.player-tag button').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        if (hasMatchesGenerated) {
                            if (!confirm('å·²å­˜åœ¨å¯¹é˜µè¡¨ï¼Œåˆ é™¤é€‰æ‰‹å°†æ¸…ç©ºå½“å‰å¯¹é˜µè¡¨å’Œæ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                                return;
                            }
                            resetTournament();
                        }
                        
                        const index = players.findIndex(p => p.id === id);
                        if (index !== -1) {
                            players.splice(index, 1);
                            updatePlayerList();
                        }
                    });
                });
                
                // æ›´æ–°è½®æ¬¡é€‰é¡¹
                updateRoundOptions();
            }
            
            // ç”Ÿæˆå”¯ä¸€ID
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // æ›´æ–°è½®æ¬¡é€‰é¡¹
            function updateRoundOptions() {
                elements.roundOptions.innerHTML = '';
                
                if (players.length < (currentMode === 'singles' ? 2 : 4)) {
                    elements.roundOptions.disabled = true;
                    elements.roundOptions.innerHTML = `<option value="">è‡³å°‘éœ€è¦${currentMode === 'singles' ? '2' : '4'}åé€‰æ‰‹</option>`;
                    elements.generateMatches.disabled = true;
                    return;
                }
                
                elements.roundOptions.disabled = false;
                elements.generateMatches.disabled = false;
                
                let baseMatches;
                let matchesPerPlayer;
                
                if (currentMode === 'singles') {
                    baseMatches = players.length * (players.length - 1) / 2;
                    matchesPerPlayer = players.length - 1;
                } else {
                    // åŒæ‰“æ¨¡å¼ä¸‹çš„æ¯”èµ›åœºæ¬¡è®¡ç®—
                    const n = players.length;
                    if (n === 4) {
                        baseMatches = 3; // 4äººå…±3åœº
                        matchesPerPlayer = 3; // æ¯äºº3åœº
                    } else if (n <= 7) {
                        // 5-7äººæ¯äºº4åœº
                        matchesPerPlayer = 4;
                        baseMatches = Math.ceil((n * matchesPerPlayer) / 4);
                    } else {
                        // 8äººåŠä»¥ä¸Šæ¯äºº8åœº
                        matchesPerPlayer = 8;
                        baseMatches = Math.ceil((n * matchesPerPlayer) / 4);
                    }
                }
                
                // åŠ¨æ€ç”Ÿæˆè½®æ¬¡é€‰é¡¹
                const roundOptions = [
                    { value: 1, label: `å•å¾ªç¯ï¼ˆæ¯äººçº¦${matchesPerPlayer}åœºï¼Œå…±${baseMatches}åœºï¼‰` },
                    { value: 2, label: `åŒå¾ªç¯ï¼ˆæ¯äººçº¦${matchesPerPlayer*2}åœºï¼Œå…±${baseMatches*2}åœºï¼‰` },
                    { value: 3, label: `ä¸‰å¾ªç¯ï¼ˆæ¯äººçº¦${matchesPerPlayer*3}åœºï¼Œå…±${baseMatches*3}åœºï¼‰` }
                ];
                
                roundOptions.forEach(option => {
                    const optElement = document.createElement('option');
                    optElement.value = option.value;
                    optElement.textContent = option.label;
                    elements.roundOptions.appendChild(optElement);
                });
                
                elements.roundOptions.selectedIndex = 0;
                updateTotalMatches();
            }
            
            // æ›´æ–°æ€»æ¯”èµ›åœºæ•°
            function updateTotalMatches() {
                if (players.length < (currentMode === 'singles' ? 2 : 4)) {
                    elements.totalMatches.textContent = '0';
                    return;
                }
                
                const n = players.length;
                let baseMatches;
                
                if (currentMode === 'singles') {
                    baseMatches = n * (n - 1) / 2;
                } else {
                    if (n === 4) {
                        baseMatches = 3; // 4äººå…±3åœº
                    } else if (n <= 7) {
                        // 5-7äººæ¯äºº4åœº
                        baseMatches = Math.ceil((n * 4) / 4);
                    } else {
                        // 8äººåŠä»¥ä¸Šæ¯äºº8åœº
                        baseMatches = Math.ceil((n * 8) / 4);
                    }
                }
                
                const rounds = parseInt(elements.roundOptions.value) || 1;
                elements.totalMatches.textContent = baseMatches * rounds;
            }
            
            // åˆ‡æ¢å•æ‰“/åŒæ‰“æ¨¡å¼
            function switchMode(mode) {
                currentMode = mode;
                document.getElementById('singlesMode').classList.toggle('active', mode === 'singles');
                document.getElementById('doublesMode').classList.toggle('active', mode === 'doubles');
                
                // æ¸…ç©ºå·²æœ‰çš„æ¯”èµ›
                if (hasMatchesGenerated) {
                    if (!confirm('åˆ‡æ¢æ¨¡å¼å°†æ¸…ç©ºå½“å‰å¯¹é˜µè¡¨å’Œæ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        // å¦‚æœç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤ä¹‹å‰çš„æ¨¡å¼
                        document.getElementById('singlesMode').classList.toggle('active', currentMode === 'singles');
                        document.getElementById('doublesMode').classList.toggle('active', currentMode === 'doubles');
                        return;
                    }
                    resetTournament();
                }
                
                // æ›´æ–°è½®æ¬¡é€‰é¡¹å’Œåœºæ¬¡è®¡ç®—
                updateRoundOptions();
            }
            
            // ç”Ÿæˆå¯¹é˜µè¡¨
            function generateMatches() {
                if (hasMatchesGenerated) {
                    if (!confirm('å·²å­˜åœ¨å¯¹é˜µè¡¨ï¼Œé‡æ–°ç”Ÿæˆå°†æ¸…ç©ºå½“å‰æ‰€æœ‰æ¯”èµ›è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        return;
                    }
                }
                
                const rounds = parseInt(elements.roundOptions.value) || 1;
                
                // åˆå§‹åŒ–æ¯”èµ›ç³»ç»Ÿ
                if (currentMode === 'singles') {
                    ovo.init(players);
                    ovo.generateUniqueMatches(rounds);
                } else {
                    tvt.init(players, 'doubles');
                    tvt.generateDoubleMatches(rounds);
                }
                
                // æ˜¾ç¤ºå¯¹é˜µè¡¨
                displayMatches();
                
                // æ˜¾ç¤ºç§¯åˆ†æ¦œ
                displayStandings();
                
                // è®¾ç½®å·²ç”Ÿæˆæ ‡è®°
                hasMatchesGenerated = true;
            }
            
            // é‡ç½®æ¯”èµ›
            function resetTournament() {
                hasMatchesGenerated = false;
                elements.matchesContainer.innerHTML = '';
                elements.standingsTable.innerHTML = '';
                // å¦‚æœä½¿ç”¨äº†ovoå¯¹è±¡ï¼Œä¹Ÿéœ€è¦é‡ç½®
                if (typeof ovo !== 'undefined') {
                    ovo.init([]);
                }
            }
            
            // æ˜¾ç¤ºå¯¹é˜µè¡¨
            function displayMatches() {
                const matches = currentMode === 'singles' ? ovo.getMatchesTable() : tvt.getMatchesTable();
                elements.matchesContainer.innerHTML = '';
                
                let totalMatchCount = 0;
                
                matches.forEach((match, index) => {
                    totalMatchCount++;
                    const matchCard = document.createElement('div');
                    matchCard.className = 'match-card';
                    
                    // æ ¹æ®ç­›é€‰çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤º
                    if (selectedPlayers.length > 0) {
                        // åœ¨åŒæ‰“æ¨¡å¼ä¸‹ï¼Œéœ€è¦æ£€æŸ¥æ¯ä¸ªé˜Ÿä¼ä¸­çš„æ‰€æœ‰é€‰æ‰‹
                        if (currentMode === 'doubles') {
                            const allPlayers = match.players.split(' VS ').join('/').split('/');
                            if (!selectedPlayers.some(p => allPlayers.includes(p))) {
                                matchCard.style.display = 'none';
                            }
                        } else {
                            if (!selectedPlayers.some(p => match.players.includes(p))) {
                                matchCard.style.display = 'none';
                            }
                        }
                    }
                    
                    // è·å–å·²ä¿å­˜çš„æ¯”åˆ†
                    const [score1, score2] = match.score !== '-' ? match.score.split('-').map(Number) : [0, 0];
                    
                    // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„é€‰æ‰‹ä¿¡æ¯
                    const playersDisplay = currentMode === 'singles' 
                        ? match.players 
                        : match.players.replace(' VS ', '<br>VS<br>');
                    
                    matchCard.innerHTML = `
                        <div class="match-header">
                            <div class="match-info">
                                <span class="round-info">ç¬¬ ${match.round} è½®</span>
                                <span class="match-number">ç¬¬ ${totalMatchCount} åœº</span>
                            </div>
                            <span class="match-status">${match.played ? (match.forceSaved ? 'âš ï¸ å·²ç»“æŸ(å¼ºåˆ¶)' : 'âœ” å·²å®Œæˆ') : 'ğŸ•’ æœªå¼€å§‹'}</span>
                        </div>
                        <div class="match-players">
                            ${playersDisplay.split(' VS ').map(team => {
                                const players = team.split('/');
                                return players.map(player => 
                                    `<span class="player-name ${selectedPlayers.includes(player) ? 'selected' : ''}" 
                                           data-player="${player}">${player}</span>`
                                ).join('<span class="team-separator">/</span>');
                            }).join('<span class="vs-text">VS</span>')}
                        </div>
                        <div class="match-score">
                            <span class="score-label">æ¯”åˆ†ï¼š</span>
                            <input type="number" min="0" max="30" maxlength="2" 
                                   oninput="if(this.value.length > 2) this.value=this.value.slice(0,2)" 
                                   class="score-input player1-score" placeholder="0"
                                   value="${match.played ? score1 : ''}"
                                   ${match.played ? 'disabled' : ''}>
                            <span class="score-separator">:</span>
                            <input type="number" min="0" max="30" maxlength="2" 
                                   oninput="if(this.value.length > 2) this.value=this.value.slice(0,2)" 
                                   class="score-input player2-score" placeholder="0"
                                   value="${match.played ? score2 : ''}"
                                   ${match.played ? 'disabled' : ''}>
                            <button class="save-score" data-match-id="${match.id}" ${match.played ? 'disabled' : ''}>
                                ä¿å­˜
                            </button>
                            <button class="edit-score" data-match-id="${match.id}" style="display: ${match.played ? 'inline-block' : 'none'}">
                                ä¿®æ”¹
                            </button>
                            <span class="score-error" style="color: red; display: none;"></span>
                        </div>
                    `;
                    
                    // æ·»åŠ æ ·å¼
                    const style = document.createElement('style');
                    style.textContent = `
                        .match-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                            font-weight: bold;
                        }
                        
                        .match-info {
                            display: flex;
                            gap: 15px;
                            align-items: center;
                        }
                        
                        .round-info {
                            color: var(--primary-color);
                        }
                        
                        .match-number {
                            background-color: #f0f0f0;
                            padding: 2px 8px;
                            border-radius: 12px;
                            font-size: 0.9em;
                            color: #666;
                        }
                        
                        .match-status {
                            font-size: 0.9em;
                        }
                        
                        .player-name {
                            cursor: pointer;
                            padding: 2px 8px;
                            border-radius: 4px;
                            transition: all 0.2s;
                        }
                        
                        .player-name:hover {
                            background-color: #f0f0f0;
                        }
                        
                        .player-name.selected {
                            background-color: var(--primary-color);
                            color: white;
                        }
                        
                        .match-card {
                            transition: all 0.3s ease;
                        }
                        
                        .score-input:disabled {
                            background-color: #f5f5f5;
                            color: #666;
                        }
                        
                        .save-score:disabled {
                            background-color: #cccccc;
                            cursor: not-allowed;
                        }
                        
                        .edit-score {
                            background-color: #ffa500;
                            color: white;
                            border: none;
                            padding: 4px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-left: 5px;
                        }
                        
                        .edit-score:hover {
                            background-color: #ff8c00;
                        }
                    `;
                    
                    matchCard.appendChild(style);
                    elements.matchesContainer.appendChild(matchCard);
                    
                    // æ·»åŠ é€‰æ‰‹åå­—ç‚¹å‡»äº‹ä»¶
                    const playerNames = matchCard.querySelectorAll('.player-name');
                    playerNames.forEach(nameSpan => {
                        nameSpan.addEventListener('click', function() {
                            const playerName = this.getAttribute('data-player');
                            togglePlayerFilter(playerName);
                        });
                    });
                    
                    // æ·»åŠ ä¿®æ”¹æŒ‰é’®äº‹ä»¶
                    const editButton = matchCard.querySelector('.edit-score');
                    if (editButton) {
                        editButton.addEventListener('click', function() {
                            if (confirm('ç¡®å®šè¦ä¿®æ”¹è¿™åœºæ¯”èµ›çš„æ¯”åˆ†å—ï¼Ÿè¿™å°†å½±å“ç§¯åˆ†æ¦œæ’åã€‚')) {
                                const inputs = matchCard.querySelectorAll('.score-input');
                                const saveButton = matchCard.querySelector('.save-score');
                                inputs.forEach(input => input.disabled = false);
                                saveButton.disabled = false;
                                this.style.display = 'none';
                            }
                        });
                    }
                });
                
                // ä¿®æ”¹æ¯”åˆ†ä¿å­˜äº‹ä»¶å¤„ç†
                document.querySelectorAll('.save-score').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const matchCard = this.closest('.match-card');
                        const player1ScoreInput = matchCard.querySelector('.player1-score');
                        const player2ScoreInput = matchCard.querySelector('.player2-score');
                        const player1Score = parseInt(player1ScoreInput.value) || 0;
                        const player2Score = parseInt(player2ScoreInput.value) || 0;
                        const errorSpan = matchCard.querySelector('.score-error');
                        const editButton = matchCard.querySelector('.edit-score');
                        const matchId = this.getAttribute('data-match-id');

                        // è·å–å½“å‰æ¯”èµ›çš„ä¿å­˜å°è¯•æ¬¡æ•°
                        let attempts = saveAttempts.get(matchId) || 0;
                        
                        // éªŒè¯æ¯”åˆ†
                        const validationResult = validateBadmintonScore(player1Score, player2Score);
                        
                        // å¦‚æœéªŒè¯ä¸é€šè¿‡ä½†ä¸æ˜¯å› ä¸ºæœªè¾¾åˆ°21åˆ†ï¼Œç›´æ¥æ˜¾ç¤ºé”™è¯¯
                        if (!validationResult.valid && validationResult.message !== 'æ¯”èµ›å¿…é¡»æœ‰ä¸€æ–¹è¾¾åˆ°21åˆ†æ‰èƒ½ç»“æŸ') {
                            errorSpan.textContent = validationResult.message;
                            errorSpan.style.display = 'block';
                            return;
                        }
                        
                        // å¦‚æœæ˜¯å› ä¸ºæœªè¾¾åˆ°21åˆ†çš„éªŒè¯å¤±è´¥
                        if (!validationResult.valid && validationResult.message === 'æ¯”èµ›å¿…é¡»æœ‰ä¸€æ–¹è¾¾åˆ°21åˆ†æ‰èƒ½ç»“æŸ') {
                            attempts++;
                            saveAttempts.set(matchId, attempts);
                            
                            if (attempts === 1) {
                                errorSpan.textContent = 'æ¯”èµ›å¿…é¡»æœ‰ä¸€æ–¹è¾¾åˆ°21åˆ†æ‰èƒ½ç»“æŸ';
                                errorSpan.style.display = 'block';
                                return;
                            } else if (attempts === 2) {
                                errorSpan.textContent = 'æ¯”èµ›å¿…é¡»æœ‰ä¸€æ–¹è¾¾åˆ°21åˆ†æ‰èƒ½ç»“æŸï¼Œå¦‚ä¸´æ—¶ç»“æŸï¼Œè¯·å†æ¬¡ç‚¹å‡»ä¿å­˜';
                                errorSpan.style.display = 'block';
                                return;
                            }
                            // ç¬¬ä¸‰æ¬¡ç‚¹å‡»æ—¶ç»§ç»­æ‰§è¡Œä¿å­˜é€»è¾‘
                        }
                        
                        // æ¸…é™¤é”™è¯¯æç¤º
                        errorSpan.style.display = 'none';
                        const score = `${player1Score}-${player2Score}`;
                        
                        if (currentMode === 'singles' ? ovo.recordScore(matchId, score) : tvt.recordScore(matchId, score)) {
                            // æ¸…é™¤ä¿å­˜å°è¯•è®°å½•
                            saveAttempts.delete(matchId);
                            
                            // ç¦ç”¨è¾“å…¥æ¡†å’Œä¿å­˜æŒ‰é’®
                            player1ScoreInput.disabled = true;
                            player2ScoreInput.disabled = true;
                            this.disabled = true;
                            
                            // æ˜¾ç¤ºä¿®æ”¹æŒ‰é’®
                            editButton.style.display = 'inline-block';
                            
                            // æ›´æ–°æ¯”èµ›çŠ¶æ€æ˜¾ç¤º
                            const statusSpan = matchCard.querySelector('.match-header span:last-child');
                            if (statusSpan) {
                                // å¦‚æœæ˜¯å¼ºåˆ¶ä¿å­˜ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ ‡è®°
                                if (!validationResult.valid) {
                                    statusSpan.textContent = 'âš ï¸ å·²ç»“æŸ(å¼ºåˆ¶)';
                                } else {
                                    statusSpan.textContent = 'âœ” å·²å®Œæˆ';
                                }
                            }
                            
                            // æ›´æ–°ç§¯åˆ†æ¦œ
                            displayStandings();
                        }
                    });
                });

                // ä¿®æ”¹ç¼–è¾‘æŒ‰é’®äº‹ä»¶å¤„ç†ï¼Œéœ€è¦æ¸…é™¤ä¿å­˜å°è¯•è®°å½•
                document.querySelectorAll('.edit-score').forEach(btn => {
                    btn.addEventListener('click', function() {
                        if (confirm('ç¡®å®šè¦ä¿®æ”¹è¿™åœºæ¯”èµ›çš„æ¯”åˆ†å—ï¼Ÿè¿™å°†å½±å“ç§¯åˆ†æ¦œæ’åã€‚')) {
                            const matchCard = this.closest('.match-card');
                            const matchId = matchCard.querySelector('.save-score').getAttribute('data-match-id');
                            const inputs = matchCard.querySelectorAll('.score-input');
                            const saveButton = matchCard.querySelector('.save-score');
                            
                            // æ¸…é™¤è¯¥æ¯”èµ›çš„ä¿å­˜å°è¯•è®°å½•
                            saveAttempts.delete(matchId);
                            
                            // å¯ç”¨è¾“å…¥æ¡†å’Œä¿å­˜æŒ‰é’®
                            inputs.forEach(input => input.disabled = false);
                            saveButton.disabled = false;
                            
                            // éšè—ä¿®æ”¹æŒ‰é’®
                            this.style.display = 'none';
                            
                            // æ›´æ–°æ¯”èµ›çŠ¶æ€æ˜¾ç¤º
                            const statusSpan = matchCard.querySelector('.match-header span:last-child');
                            if (statusSpan) {
                                statusSpan.textContent = 'ğŸ•’ è¿›è¡Œä¸­';
                            }
                            
                            // æ¸…é™¤é”™è¯¯æç¤º
                            const errorSpan = matchCard.querySelector('.score-error');
                            errorSpan.style.display = 'none';
                        }
                    });
                });
            }
            
            // æ˜¾ç¤ºç§¯åˆ†æ¦œ
            function displayStandings() {
                const standings = currentMode === 'singles' ? ovo.getStandings() : tvt.getStandings();
                elements.standingsTable.innerHTML = '';
                
                standings.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const winRate = player.matches > 0 
                        ? Math.round(player.wins / player.matches * 100) 
                        : 0;
                    
                    // ä¸ºå‰ä¸‰åæ·»åŠ ç‰¹æ®Šæ ·å¼
                    let rankStyle = '';
                    if (index === 0) {
                        rankStyle = 'background-color: #FFD700; color: white;'; // é‡‘ç‰Œ
                    } else if (index === 1) {
                        rankStyle = 'background-color: #C0C0C0; color: white;'; // é“¶ç‰Œ
                    } else if (index === 2) {
                        rankStyle = 'background-color: #CD7F32; color: white;'; // é“œç‰Œ
                    }
                    
                    row.innerHTML = `
                        <td style="${rankStyle}">${index + 1}</td>
                        <td style="${rankStyle}">${player.player.name}</td>
                        <td style="${rankStyle}">${player.wins}</td>
                        <td style="${rankStyle}">${player.points}</td>
                        <td style="${rankStyle}">${player.matches}</td>
                        <td style="${rankStyle}">${winRate}%</td>
                    `;
                    elements.standingsTable.appendChild(row);
                });
            }
            
            // ä¿®æ”¹é€‰æ‰‹ç­›é€‰åˆ‡æ¢å‡½æ•°
            function togglePlayerFilter(playerName) {
                const index = selectedPlayers.indexOf(playerName);
                if (index === -1) {
                    // å¦‚æœæœªé€‰ä¸­ï¼Œä¸”æœªè¾¾åˆ°ä¸Šé™ï¼Œåˆ™æ·»åŠ 
                    if (selectedPlayers.length < 2) {
                        selectedPlayers.push(playerName);
                    } else {
                        // å¦‚æœå·²è¾¾ä¸Šé™ï¼Œç§»é™¤æœ€æ—©é€‰ä¸­çš„
                        selectedPlayers.shift();
                        selectedPlayers.push(playerName);
                    }
                } else {
                    // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™ç§»é™¤
                    selectedPlayers.splice(index, 1);
                }
                
                // é‡æ–°æ˜¾ç¤ºå¯¹é˜µè¡¨ä»¥åæ˜ ç­›é€‰ç»“æœ
                displayMatches();
            }
            
            // ä¿®æ”¹é‡ç½®ç­›é€‰å‡½æ•°
            function resetFilter() {
                selectedPlayers = [];
                displayMatches();
            }
            
            // åˆå§‹åŒ–è½®æ¬¡é€‰é¡¹
            elements.roundOptions.addEventListener('change', updateTotalMatches);
        });

        // æ·»åŠ ç¾½æ¯›çƒæ¯”åˆ†éªŒè¯å‡½æ•°
        function validateBadmintonScore(score1, score2) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(score1) || isNaN(score2)) {
                return { valid: false, message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—' };
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºéè´Ÿæ•°
            if (score1 < 0 || score2 < 0) {
                return { valid: false, message: 'æ¯”åˆ†ä¸èƒ½ä¸ºè´Ÿæ•°' };
            }
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å€¼30åˆ†
            if (score1 > 30 || score2 > 30) {
                return { valid: false, message: 'å•å±€æ¯”èµ›æœ€é«˜åˆ†ä¸èƒ½è¶…è¿‡30åˆ†' };
            }
            
            // å¦‚æœæ¯”åˆ†ç›¸åŒï¼Œåªå…è®¸éƒ½æ˜¯0çš„æƒ…å†µ
            if (score1 === score2 && score1 !== 0) {
                return { valid: false, message: 'æ¯”èµ›ç»“æŸæ—¶æ¯”åˆ†ä¸èƒ½ç›¸åŒ' };
            }
            
            const maxScore = Math.max(score1, score2);
            const minScore = Math.min(score1, score2);
            
            // å¦‚æœæœ‰ä¸€æ–¹è¾¾åˆ°30åˆ†ï¼Œç›´æ¥åˆ¤å®šä¸ºæœ‰æ•ˆ
            if (maxScore === 30) {
                return { valid: true };
            }
            
            // å¸¸è§„è·èƒœæ¡ä»¶ï¼š21åˆ†ä¸”é¢†å…ˆ2åˆ†
            if (maxScore >= 21) {
                // åˆ†å·®éªŒè¯
                const scoreDiff = maxScore - minScore;
                if (scoreDiff < 2) {
                    return { valid: false, message: 'è·èƒœæ–¹å¿…é¡»é¢†å…ˆ2åˆ†' };
                }
                
                // å¦‚æœè¶…è¿‡21åˆ†ä½†æœªåˆ°30åˆ†ï¼Œåˆ™éœ€è¦éªŒè¯æ˜¯å¦ç¬¦åˆå»¶é•¿èµ›è§„åˆ™
                if (maxScore > 21) {
                    // å»¶é•¿èµ›å¿…é¡»åˆšå¥½é¢†å…ˆ2åˆ†
                    if (scoreDiff !== 2) {
                        return { valid: false, message: 'å»¶é•¿èµ›å¿…é¡»åˆšå¥½é¢†å…ˆ2åˆ†' };
                    }
                }
                
                return { valid: true };
            }
            
            // å¦‚æœæœ€é«˜åˆ†æœªè¾¾åˆ°21åˆ†
            return { valid: false, message: 'æ¯”èµ›å¿…é¡»æœ‰ä¸€æ–¹è¾¾åˆ°21åˆ†æ‰èƒ½ç»“æŸ' };
        }
    </script>
    
    <script src="ovo.js"></script>
    <script src="tvt.js"></script>
</body>
</html>